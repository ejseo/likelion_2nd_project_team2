AWSTemplateFormatVersion: '2010-09-09'
Description: SG for Travelog (ALB, ECS, RDS)

Parameters:
  VPCId: # ğŸ‘ˆ íŒŒë¼ë¯¸í„° ì´ë¦„: VPCId
    Type: AWS::EC2::VPC::Id
    Description: ë³´ì•ˆ ê·¸ë£¹ì„ ìƒì„±í•  ëŒ€ìƒ VPCì˜ ID

Resources:

  # 1. ALBìš© ë³´ì•ˆ ê·¸ë£¹ (SG-ALB)
  AlbSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: ALB Ingress (80, 443) from Internet
      VpcId: !Ref VPCId
      SecurityGroupIngress:
        # Inbound TCP 80 from Internet
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        # Inbound TCP 443 from Internet
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
      SecurityGroupEgress:
        # Outbound ALL to ALL (ECSë¡œ íŠ¸ë˜í”½ì„ ë‚´ë³´ë‚´ê¸° ìœ„í•´ í•„ìš”í•œ ê¸°ë³¸ ì„¤ì •)
        - IpProtocol: "-1"
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: SG-ALB

  # 2. ECS íƒœìŠ¤í¬ìš© ë³´ì•ˆ ê·¸ë£¹ (SG-ECS)
  EcsSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: ECS Task access from ALB, to RDS and Internet
      VpcId: !Ref VPCId
      SecurityGroupIngress:
        # Inbound TCP 8080 from SG-ALB (Application Load Balancer)
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          SourceSecurityGroupId: !Ref AlbSecurityGroup
      SecurityGroupEgress:
        # Outbound TCP 443 to Internet (ECR/S3 access)
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
        # âš ï¸ Outbound TCP 3306 to RDS ê·œì¹™ì€ ì•„ë˜ì˜ EcsToRdsEgressRuleë¡œ ë¶„ë¦¬ë¨ âš ï¸
      Tags:
        - Key: Name
          Value: SG-ECS

  # 3. RDS ë°ì´í„°ë² ì´ìŠ¤ìš© ë³´ì•ˆ ê·¸ë£¹ (SG-RDS)
  RdsSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: RDS access from ECS tasks only
      VpcId: !Ref VPCId
      SecurityGroupIngress:
        # Inbound TCP 3306 from SG-ECS only (ì´ê²ƒì€ ì—¬ê¸°ì— ìœ ì§€)
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref EcsSecurityGroup
      SecurityGroupEgress:
        # Outbound ALL to ALL (ê¸°ë³¸ê°’)
        - IpProtocol: "-1"
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: SG-RDS

  # 4. ìˆœí™˜ ì¢…ì†ì„±ì„ í•´ê²°í•˜ê¸° ìœ„í•´ ECS -> RDSì˜ Egress ê·œì¹™ì„ ë³„ë„ë¡œ ìƒì„±
  EcsToRdsEgressRule:
    Type: AWS::EC2::SecurityGroupEgress
    Properties:
      # ECS ë³´ì•ˆ ê·¸ë£¹ì— ê·œì¹™ì„ ì ìš©
      GroupId: !Ref EcsSecurityGroup
      IpProtocol: tcp
      FromPort: 3306
      ToPort: 3306
      # ëª©ì ì§€ëŠ” RDS ë³´ì•ˆ ê·¸ë£¹
      DestinationSecurityGroupId: !Ref RdsSecurityGroup

Outputs:
  AlbSecurityGroupId:
    Description: ALBìš© ë³´ì•ˆ ê·¸ë£¹ ID
    Value: !Ref AlbSecurityGroup
  EcsSecurityGroupId:
    Description: ECS íƒœìŠ¤í¬ìš© ë³´ì•ˆ ê·¸ë£¹ ID
    Value: !Ref EcsSecurityGroup
  RdsSecurityGroupId:
    Description: RDS ë°ì´í„°ë² ì´ìŠ¤ìš© ë³´ì•ˆ ê·¸ë£¹ ID
    Value: !Ref RdsSecurityGroup